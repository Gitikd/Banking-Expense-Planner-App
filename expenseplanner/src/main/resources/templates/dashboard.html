<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Banking Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .section { display: none; }
    </style>
</head>
<body>
<!-- Sticky Header with Logo -->
<nav class="navbar navbar-light bg-light sticky-top shadow-sm px-3">
    <a class="navbar-brand d-flex align-items-center" href="#">
        <img src="/images/VisionWallet.png" alt="VisionWallet Logo" height="40" class="me-2">
    </a>
</nav>


<div class="container mt-5">
    <h2>Welcome, <span id="userName">User</span>!</h2>

    <!-- üîπ Banking Summary -->
    <div class="row my-4">
        <div class="col-md-4">
            <div class="card text-bg-success">
                <div class="card-body">
                    <h5>Total Balance</h5>
                    <p id="balance">‚Çπ...</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-primary">
                <div class="card-body">
                    <h5>Total Income</h5>
                    <p id="income">‚Çπ...</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-danger">
                <div class="card-body">
                    <h5>Total Expenses</h5>
                    <p id="expense">‚Çπ...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- üîò Navigation Buttons -->
    <div class="mb-4">
        <button class="btn btn-outline-dark me-2" onclick="showSection('addTx')">‚ûï Add Transaction</button>
        <button class="btn btn-outline-dark me-2" onclick="showSection('txTable')">üìú View Transactions</button>
        <button class="btn btn-outline-dark me-2" onclick="showSection('reminder')">üîî Reminders</button>
        <button class="btn btn-outline-dark me-2" onclick="showSection('budget')">üí∞ Budget</button>
        <button class="btn btn-outline-dark me-2" onclick="showSection('savings')">üéØ Savings Goals</button>
        <button class="btn btn-danger float-end" onclick="logout()">Logout</button>
    </div>

    <!-- üì• Transaction Form -->
	<div id="addTx" class="section">
	    <h4>Add Transaction</h4>
	    <form id="expenseForm">
	        <div class="row">
	            <div class="col-md-3 mb-2">
	                <label>Category</label>
	                <input type="text" class="form-control" id="category" required>
	            </div>
	            <div class="col-md-3 mb-2">
	                <label>Description</label>
	                <input type="text" class="form-control" id="description" required>
	            </div>
	            <div class="col-md-2 mb-2">
	                <label>Amount (‚Çπ)</label>
	                <input type="number" class="form-control" id="amount" required step="0.01">
	            </div>
	            <div class="col-md-2 mb-2">
	                <label>Date</label>
	                <input type="date" class="form-control" id="date" required>
	            </div>
	            <div class="col-md-2 mb-2">
	                <label>Type</label>
	                <select class="form-control" id="type" required>
	                    <option value="INCOME">Income</option>
	                    <option value="EXPENSE">Expense</option>
	                </select>
	            </div>
	        </div>
	        <button type="submit" class="btn btn-success mt-2">Save Transaction</button>
	    </form>
	</div>



    <!-- üìú Transactions Table -->
    <div id="txTable" class="section">

    	<!-- üìÖ Filter Transactions -->
	<div class="row mb-3">
	    <div class="col-md-3">
	        <label>Start Date</label>
	        <input type="date" class="form-control" id="txStartDate">
	    </div>
	    <div class="col-md-3">
	        <label>End Date</label>
	        <input type="date" class="form-control" id="txEndDate">
	    </div>
	    <div class="col-md-3 d-flex align-items-end">
	        <button class="btn btn-primary me-2" onclick="filterTransactions()">üîç Filter</button>
	        <button class="btn btn-secondary" onclick="resetTransactionFilter()">üîÅ Reset</button>
	    </div>
	</div>

        <h4>Transaction History</h4>
        <table class="table">

            <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Type</th></tr></thead>
            <tbody id="transactionTable"></tbody>
        </table>
    </div>

    <!-- üîî Reminders -->
	<div id="reminder" class="section">
	    <h4>üîî Add Bill Reminder</h4>
	    <form id="reminderForm">
    <div class="row">
        <div class="col-md-4 mb-2">
            <label>Title</label>
            <input type="text" class="form-control" id="reminderTitle" required>
        </div>
        <div class="col-md-4 mb-2">
            <label>Note</label>
            <input type="text" class="form-control" id="reminderNote">
        </div>
        <div class="col-md-4 mb-2">
            <label>Due Date</label>
            <input type="date" class="form-control" id="reminderDate" required>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4 mb-2">
            <label>Amount</label>
            <input type="number" class="form-control" id="reminderAmount" required step="0.01">
        </div>
        <div class="col-md-4 mb-2">
            <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" id="reminderRecurring">
                <label class="form-check-label">Repeat Monthly</label>
            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-warning" id="reminderSubmitBtn">Add Reminder</button>
</form>


	    <hr class="my-4">
	    <h5>üìÖ Upcoming Reminders (Next 7 Days)</h5>
	    <table class="table table-striped">
	        <thead>
	        <tr>
	            <th>Title</th>
	            <th>Note</th>
	            <th>Due Date</th>
	            <th>Recurring</th>
	            <th>Amount</th>
    				<th>Actions</th>
	        </tr>
	        </thead>
	        <tbody id="reminderTable">
	        <!-- populated dynamically -->
	        </tbody>
	    </table>
	</div>


    <!-- üí∞ Budget -->
	<div id="budget" class="section">
	    <h4>üí∞ Monthly Budget Planner</h4>

	    <form id="budgetForm">
	        <div class="row">
	            <div class="col-md-3 mb-2">
	                <label>Category</label>
	                <input type="text" class="form-control" id="budgetCategory" required>
	            </div>
	            <div class="col-md-3 mb-2">
	                <label>Limit Amount</label>
	                <input type="number" class="form-control" id="budgetAmount" required step="0.01">
	            </div>
	            <div class="col-md-3 mb-2">
	                <label>Month</label>
	                <select id="budgetMonth" class="form-control" required>
	                    <option value="">Select</option>
				        <option value="1">January</option>
				        <option value="2">February</option>
				        <option value="3">March</option>
				        <option value="4">April</option>
				        <option value="5">May</option>
				        <option value="6">June</option>
				        <option value="7">July</option>
				        <option value="8">August</option>
				        <option value="9">September</option>
				        <option value="10">October</option>
				        <option value="11">November</option>
				        <option value="12">December</option>
	                </select>
	            </div>
	            <div class="col-md-3 mb-2">
	                <label>Year</label>
	                <input type="number" class="form-control" id="budgetYear" required value="2025">
	            </div>
	        </div>
	        <button type="submit" class="btn btn-primary">‚ûï Add Budget</button>
	    </form>

	    <hr class="my-4">
	    <h5>üìä Your Budget Summary</h5>
	    <!-- üí∞ Filter Budgets -->
		<div class="row mb-3">
		  <div class="col-md-3">
		    <label>Month</label>
		    <select id="budgetFilterMonth" class="form-control">
		      <option value="">All</option>
		      <option value="1">January</option>
		      <option value="2">February</option>
		      <option value="3">March</option>
		      <option value="4">April</option>
		      <option value="5">May</option>
		      <option value="6">June</option>
		      <option value="7">July</option>
		      <option value="8">August</option>
		      <option value="9">September</option>
		      <option value="10">October</option>
		      <option value="11">November</option>
		      <option value="12">December</option>
		    </select>
		  </div>
		  <div class="col-md-3">
		    <label>Year</label>
		    <input type="number" id="budgetFilterYear" class="form-control" placeholder="e.g. 2025">
		  </div>
		  <div class="col-md-3 d-flex align-items-end">
		    <button class="btn btn-primary me-2" onclick="applyBudgetFilter()">üîç Filter</button>
		    <button class="btn btn-secondary" onclick="resetBudgetFilter()">üîÅ Reset</button>
		  </div>
		</div>

	    <table class="table table-bordered">
	        <thead>
	        <tr>
	            <th>Category</th>
	            <th>Amount</th>
	            <th>Month</th>
	            <th>Year</th>
	            <th>Actions</th>
	        </tr>
	        </thead>
	        <tbody id="budgetTable">
	        <!-- Filled by JS -->
	        </tbody>
	    </table>
	</div>


	<!-- üéØ Savings Goals -->
	<div id="savings" class="section">
	    <h4>üéØ Add New Savings Goal</h4>
	    <form id="savingsForm">
	        <div class="row">
	            <div class="col-md-4 mb-2">
	                <label>Goal Name</label>
	                <input type="text" class="form-control" id="goalName" required>
	            </div>
				<div class="col-md-4 mb-2">
				    <label>Description</label>
				    <input type="text" class="form-control" id="goalDescription" required>
				</div>
	            <div class="col-md-4 mb-2">
	                <label>Target Amount</label>
	                <input type="number" class="form-control" id="targetAmount" required step="0.01">
	            </div>
	        </div>
	        <button type="submit" class="btn btn-success">‚ûï Add Goal</button>
	    </form>

	    <hr class="my-4">
	    <h5>üìä Your Savings Goals</h5>
	    <table class="table table-bordered">
	        <thead>
	        <tr>
	            <th>Goal</th>
	            <th>Description</th>
	            <th>Target</th>
	            <th>Saved</th>
	            <th>Status</th>
	            <th>Actions</th>
	        </tr>
	        </thead>
	        <tbody id="savingsTable">
	        <!-- Filled dynamically -->
	        </tbody>
	    </table>
	</div>

</div>

<!-- JS Section -->
<script>
    const token = localStorage.getItem("jwt");

    // Load banking summary
    async function loadSummary() {
        const res = await fetch("/api/banking/summary", {
            headers: { Authorization: "Bearer " + token }
        });
        const data = await res.json();
        document.getElementById("userName").innerText = data.user;
        document.getElementById("balance").innerText = "‚Çπ " + data.totalBalance.toLocaleString("en-IN", { minimumFractionDigits: 2 });

        document.getElementById("income").innerText = "‚Çπ " + data.totalIncome.toLocaleString("en-IN", { minimumFractionDigits: 2 });
        document.getElementById("expense").innerText = "‚Çπ " + data.totalExpense.toLocaleString("en-IN", { minimumFractionDigits: 2 });

    }

    // Show selected section only
    function showSection(id) {
        document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");
        document.getElementById(id).style.display = "block";
        if (id === "txTable") loadTransactions();
        if (id === "reminder") loadReminders();
        if (id === "budget") loadBudgets();
        if (id === "savings") loadSavingsGoals();
        // You can trigger budget/savings load here if needed
    }

    // Transaction table loader (reuse your loadTransactions function)
	async function loadTransactions() {
	    const token = localStorage.getItem("jwt");
	    const res = await fetch("/api/expenses/my", {
	        headers: { Authorization: "Bearer " + token }
	    });

	    const data = await res.json();
	    const table = document.getElementById("transactionTable");
	    table.innerHTML = "";

	    data.sort((a, b) => new Date(b.date) - new Date(a.date)); // Most recent first

	    data.forEach(tx => {
	        const row = `<tr>
	            <td>${tx.date}</td>
	            <td>${tx.category}</td>
	            <td>${tx.description}</td>
	            <td>‚Çπ${tx.amount.toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
</td>
	            <td>${tx.type}</td>
	        </tr>`;
	        table.innerHTML += row;
	    });
	}

	async function filterTransactions() {
	    const token = localStorage.getItem("jwt");
	    const start = document.getElementById("txStartDate").value;
	    const end = document.getElementById("txEndDate").value;

	    if (!start || !end) {
	        alert("Please select both start and end dates.");
	        return;
	    }

	    const res = await fetch(`/api/expenses/filter?start=${start}&end=${end}`, {
	        headers: { Authorization: "Bearer " + token }
	    });

	    const data = await res.json();
	    const table = document.getElementById("transactionTable");
	    table.innerHTML = "";

	    data.sort((a, b) => new Date(b.date) - new Date(a.date)); // Optional but recommended

	    data.forEach(tx => {
	        const row = `<tr>
	            <td>${tx.date}</td>
	            <td>${tx.category}</td>
	            <td>${tx.description}</td>
	            <td>‚Çπ${tx.amount.toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
</td>
	            <td>${tx.type}</td>
	        </tr>`;
	        table.innerHTML += row;
	    });
	}

	async function resetTransactionFilter() {
	    document.getElementById("txStartDate").value = "";
	    document.getElementById("txEndDate").value = "";
	    loadTransactions();
	}




//Add Transactions
    document.getElementById("expenseForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        const token = localStorage.getItem("jwt");
        const transaction = {
            category: document.getElementById("category").value,
            description: document.getElementById("description").value,
            amount: parseFloat(document.getElementById("amount").value),
            date: document.getElementById("date").value,
            type: document.getElementById("type").value
        };

        const response = await fetch("/api/expenses/add", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(transaction)
        });

        const result = await response.text();
        alert(result);

        if (response.ok) {
            loadSummary();     // refresh balance/income/expense
            loadTransactions(); // refresh history
            document.getElementById("expenseForm").reset();
        }
    });


 // Handle reminder form submit
	document.getElementById("reminderForm").addEventListener("submit", async function (event) {
	    event.preventDefault();

	    const token = localStorage.getItem("jwt");
	    const reminder = {
	        title: document.getElementById("reminderTitle").value,
	        note: document.getElementById("reminderNote").value,
	        dueDate: document.getElementById("reminderDate").value,
	        recurring: document.getElementById("reminderRecurring").checked,
	        amount: parseFloat(document.getElementById("reminderAmount").value)
	    };

	    const url = editingReminderId ? `/api/reminders/${editingReminderId}` : "/api/reminders/add";
	    const method = editingReminderId ? "PUT" : "POST";

	    const response = await fetch(url, {
	        method,
	        headers: {
	            "Content-Type": "application/json",
	            "Authorization": "Bearer " + token
	        },
	        body: JSON.stringify(reminder)
	    });

	    const result = await response.text();
	    alert(result);

	    editingReminderId = null;
	    document.getElementById("reminderForm").reset();
	    document.querySelector("#reminderForm button[type='submit']").textContent = "Add Reminder";
	    document.getElementById("reminderSubmitBtn").textContent = editingReminderId ? "üîÑ Update Reminder" : "Add Reminder";

	    loadReminders(); // reload reminder table
	});


    // Load upcoming reminders: reminder‚Äôs due date today or within the next 7 days
	async function loadReminders() {
	    const token = localStorage.getItem("jwt");
	    const response = await fetch("/api/reminders/upcoming", {
	        headers: {
	            "Authorization": "Bearer " + token
	        }
	    });

	    const reminders = await response.json();
	    // Sort reminders by due date ascending (oldest to newest)
	    reminders.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

	    const table = document.getElementById("reminderTable");
	    table.innerHTML = "";

	    const today = new Date().toISOString().split('T')[0]; // yyyy-mm-dd

	    reminders.forEach(rem => {
	        const row = document.createElement("tr");

	        // üî¥ Mark as red if overdue
	        if (rem.dueDate < today) {
	            row.classList.add("table-danger");
	        }

	        row.innerHTML = `
	        	  <td>${rem.title}</td>
	        	  <td>${rem.note || "-"}</td>
	        	  <td>${rem.dueDate}</td>
	        	  <td>${rem.recurring ? "Yes" : "No"}</td>
	        	  <td>‚Çπ${rem.amount.toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
	        	  <td>
	        	    <button class="btn btn-sm btn-success" onclick="payReminder(${rem.id})">Pay</button>
	        	    <button class="btn btn-sm btn-warning" onclick='editReminder(${JSON.stringify(rem)})'>Edit</button>
	        	    <button class="btn btn-sm btn-danger" onclick="deleteReminder(${rem.id})">Delete</button>
	        	  </td>
	        	`;

	        table.appendChild(row);
	    });
	}


 //payReminder()
	async function payReminder(id) {
	    const token = localStorage.getItem("jwt");
	    const res = await fetch(`/api/reminders/pay/${id}`, {
	        method: "PUT",
	        headers: { Authorization: "Bearer " + token }
	    });
	    alert(await res.text());
	    loadSummary();
	    loadTransactions();
	    loadReminders();
	}

	async function deleteReminder(id) {
	    const token = localStorage.getItem("jwt");
	    const confirmed = confirm("Delete this reminder?");
	    if (!confirmed) return;
	    const res = await fetch(`/api/reminders/delete/${id}`, {
	        method: "DELETE",
	        headers: { Authorization: "Bearer " + token }
	    });
	    alert(await res.text());
	    loadReminders();
	}

	let editingReminderId = null;
	function editReminder(rem) {
	    document.getElementById("reminderTitle").value = rem.title;
	    document.getElementById("reminderNote").value = rem.note;
	    document.getElementById("reminderDate").value = rem.dueDate;
	    document.getElementById("reminderRecurring").checked = rem.recurring;
	    document.getElementById("reminderAmount").value = rem.amount;
	    editingReminderId = rem.id;

	    document.querySelector("#reminderForm button[type='submit']").textContent = "üîÑ Update Reminder";
	}


    // üì§ Load budgets for selected month/year
    function getMonthName(monthNumber) {
	        const monthNames = [
	            "January", "February", "March", "April", "May", "June",
	            "July", "August", "September", "October", "November", "December"
	        ];
	        return monthNames[monthNumber - 1] || "Invalid";
	}

    async function loadBudgets(month = "", year = "") {
        const token = localStorage.getItem("jwt");

        let url = "/api/budget/my";
        if (month || year) {
            url += "?";
            if (month) url += `month=${month}&`;
            if (year) url += `year=${year}`;
        }

        const res = await fetch(url, {
            headers: { Authorization: "Bearer " + token }
        });

        const data = await res.json();

        // Sort by year desc, then month desc
        data.sort((a, b) => {
            if (b.year !== a.year) return b.year - a.year;
            return b.month - a.month;
        });

        const table = document.getElementById("budgetTable");
        table.innerHTML = "";

        if (data.length === 0) {
            table.innerHTML = `<tr><td colspan="5">No budgets found</td></tr>`;
            return;
        }

        data.forEach(item => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.category}</td>
                <td>‚Çπ${item.limitAmount.toLocaleString("en-IN", { minimumFractionDigits: 2 })}</td>
                <td>${getMonthName(item.month)}</td>
                <td>${item.year}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick='editBudget(${JSON.stringify(item)})'>‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick='deleteBudget(${item.id})'>üóëÔ∏è</button>
                </td>
            `;
            table.appendChild(row);
        });
    }

    function applyBudgetFilter() {
        const month = document.getElementById("budgetFilterMonth").value;
        const year = document.getElementById("budgetFilterYear").value;

        // Pass selected values to loadBudgets
        loadBudgets(month, year);
    }


	function resetBudgetFilter() {
	    document.getElementById("budgetFilterMonth").value = "";
	    document.getElementById("budgetFilterYear").value = "";
	    loadBudgets(); // load all
	}


	let editingBudgetId = null;

	document.getElementById("budgetForm").addEventListener("submit", async function (event) {
	    event.preventDefault();

	    const token = localStorage.getItem("jwt");
	    const category = document.getElementById("budgetCategory").value;
	    const limitAmount = parseFloat(document.getElementById("budgetAmount").value);
	    const month = parseInt(document.getElementById("budgetMonth").value);
	    const year = parseInt(document.getElementById("budgetYear").value);

	    const payload = { category, limitAmount, month, year };

	    const url = editingBudgetId ? `/api/budget/${editingBudgetId}` : "/api/budget/add";
	    const method = editingBudgetId ? "PUT" : "POST";

	    const res = await fetch(url, {
	        method,
	        headers: {
	            "Content-Type": "application/json",
	            "Authorization": "Bearer " + token
	        },
	        body: JSON.stringify(payload)
	    });

	    const msg = await res.text();
	    alert(msg);

	    editingBudgetId = null;
	    document.getElementById("budgetForm").reset();
	    document.querySelector("#budgetForm button[type='submit']").textContent = "‚ûï Add Budget";


	    loadBudgets();
	});


	// üßπ Delete budget
	async function deleteBudget(id) {
	    const token = localStorage.getItem("jwt");
	    const confirmed = confirm("Are you sure you want to delete this budget?");
	    if (!confirmed) return;

	    const res = await fetch(`/api/budget/${id}`, {
	        method: "DELETE",
	        headers: { Authorization: "Bearer " + token }
	    });

	    alert(await res.text());
	    loadBudgets();
	}

	// ‚úèÔ∏è Edit budget
	function editBudget(budget) {
	    document.getElementById("budgetCategory").value = budget.category;
	    document.getElementById("budgetAmount").value = budget.limitAmount;
	    document.getElementById("budgetMonth").value = budget.month;
	    document.getElementById("budgetYear").value = budget.year;

	    editingBudgetId = budget.id;
	    document.querySelector("#budgetForm button[type='submit']").textContent = "üîÑ Update Budget";
	}
	function editBudgetFromRow(row) {
	    document.getElementById("budgetCategory").value = row.dataset.category;
	    document.getElementById("budgetAmount").value = row.dataset.amount;
	    document.getElementById("budgetMonth").value = row.dataset.month;
	    document.getElementById("budgetYear").value = row.dataset.year;

	    editingBudgetId = row.dataset.id;

	    document.querySelector("#budgetForm button[type='submit']").textContent = "üîÑ Update Budget";
	}




	// Submit new goal
	document.getElementById("savingsForm").addEventListener("submit", async function (event) {
	    event.preventDefault();

	    const goal = {
	        goalName: document.getElementById("goalName").value,
	        description: document.getElementById("goalDescription").value,
	        targetAmount: parseFloat(document.getElementById("targetAmount").value)
	    };

	    const token = localStorage.getItem("jwt");

	    const res = await fetch("/api/savings/add", {
	        method: "POST",
	        headers: {
	            "Content-Type": "application/json",
	            "Authorization": "Bearer " + token
	        },
	        body: JSON.stringify(goal)
	    });

	    const msg = await res.text();
	    alert(msg);

	    if (res.ok) {
	        document.getElementById("savingsForm").reset();
	        loadSavingsGoals();
	    }
	});

	//Load goals and render table
	async function loadSavingsGoals() {
	    const token = localStorage.getItem("jwt");
	    const res = await fetch("/api/savings/my", {
	        headers: { Authorization: "Bearer " + token }
	    });

	    const goals = await res.json();

	    // üîΩ Sort: Incomplete goals first, then completed and purchased
	    goals.sort((a, b) => {
	        const order = { PENDING: 0, COMPLETED: 1, PURCHASED: 2 };
	        return order[a.status] - order[b.status];
	    });

	    const table = document.getElementById("savingsTable");
	    table.innerHTML = "";

	    goals.forEach(goal => {
	        const targetFormatted = goal.targetAmount.toLocaleString("en-IN", {
	            minimumFractionDigits: 2, maximumFractionDigits: 2
	        });

	        const savedFormatted = goal.savedAmount.toLocaleString("en-IN", {
	            minimumFractionDigits: 2, maximumFractionDigits: 2
	        });

	        let actions = "";

	        if (goal.status === "COMPLETED") {
	            actions = `
	                <button class="btn btn-sm btn-primary" onclick="buyGoal(${goal.id})">üõç Buy</button>
	                <button class="btn btn-sm btn-secondary" onclick="withdrawGoal(${goal.id})">üí∏ Withdraw</button>
	            `;
	        } else if (goal.status === "PURCHASED") {
	            actions = `<span class="text-success">Purchased</span>`;
	        } else {
	            actions = `
	                <button class="btn btn-sm btn-success" onclick="updateProgress(${goal.id})">üí∞ Add</button>
	                <button class="btn btn-sm btn-danger ms-1" onclick="withdrawFromGoal(${goal.id})">‚Ü©Ô∏è Withdraw</button>
	                <button class="btn btn-sm btn-danger ms-1" onclick="deleteGoal(${goal.id})">üóëÔ∏è Delete</button>
	            `;
	        }

	        const row = document.createElement("tr");
	        row.innerHTML = `
	            <td>${goal.goalName}</td>
	            <td>${goal.description || "-"}</td>
	            <td>‚Çπ${targetFormatted}</td>
	            <td>‚Çπ${savedFormatted}</td>
	            <td>${goal.status}</td>
	            <td>${actions}</td>
	        `;

	        table.appendChild(row);
	    });
	}


	//Withdraw Money From Goal
	async function withdrawFromGoal(goalId) {
	    const amount = prompt("Enter amount to withdraw:");
	    if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
	        alert("Invalid amount");
	        return;
	    }

	    const token = localStorage.getItem("jwt");

	    const res = await fetch(`/api/savings/withdraw/${goalId}?amount=${amount}`, {
	        method: "PUT",
	        headers: { Authorization: "Bearer " + token }
	    });

	    const msg = await res.text();
	    alert(msg);
	    loadSavingsGoals();
	    loadSummary(); // refresh balance
	}


	// ‚úÖ Update saved amount with validation and UI update
	async function updateProgress(goalId) {
	    const input = prompt("Enter amount to add to savings:");
	    const amountToAdd = parseFloat(input);

	    if (isNaN(amountToAdd) || amountToAdd <= 0) {
	        alert("Please enter a valid positive number.");
	        return;
	    }

	    const token = localStorage.getItem("jwt");

	    try {
	        const res = await fetch(`/api/savings/update/${goalId}?amountToAdd=${amountToAdd}`, {
	            method: "PUT",
	            headers: {
	                Authorization: "Bearer " + token
	            }
	        });

	        const msg = await res.text();
	        alert(msg);

	        // ‚úÖ Refresh banking summary + savings goal table
	        loadSummary();
	        loadSavingsGoals();
	    } catch (error) {
	        console.error("Failed to update goal progress", error);
	        alert("Something went wrong while updating the savings goal.");
	    }
	}

	//Delete The Goal
	async function deleteGoal(id) {
	    const confirmed = confirm("Are you sure you want to delete this savings goal? Its saved amount will be added back to your balance.");
	    if (!confirmed) return;

	    const token = localStorage.getItem("jwt");
	    const res = await fetch(`/api/savings/delete/${id}`, {
	        method: "DELETE",
	        headers: {
	            Authorization: "Bearer " + token
	        }
	    });

	    const msg = await res.text();
	    alert(msg);
	    loadSavingsGoals();
	    loadSummary(); // üí∞ Update balance
	}

	//Buy Handler
	async function buyGoal(goalId) {
		  const token = localStorage.getItem("jwt");
		  const res = await fetch(`/api/savings/buy/${goalId}`, {
		    method: "PUT",
		    headers: { Authorization: "Bearer " + token }
		  });

		  alert(await res.text());
		  loadSavingsGoals();
		  loadSummary();
		  loadTransactions();
		}

	//Withdraw Handler
	async function withdrawGoal(goalId) {
	  const token = localStorage.getItem("jwt");
	  const res = await fetch(`/api/savings/withdraw/${goalId}`, {
	    method: "DELETE",
	    headers: { Authorization: "Bearer " + token }
	  });

	  alert(await res.text());
	  loadSavingsGoals();
	  loadSummary();
	}



    function logout() {
        localStorage.removeItem("jwt");
        window.location.href = "/";
    }

    loadSummary(); // Load summary on page load
</script>
</body>
</html>
